<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—å‘½ç›¤ V2.4 | å½ˆæ€§æ™‚è¾°ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: "Microsoft JhengHei", "PingFang TC", Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; line-height: 1.6; padding-bottom: 80px; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 900px; position: relative; }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 14px; margin-bottom: 25px; }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 150px; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; font-size: 14px; }
        input[type="date"], input[type="time"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        /* Checkbox style */
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 5px; font-size: 13px; color: #666; cursor: pointer; }
        .checkbox-wrapper input { width: auto; cursor: pointer; }

        .gender-group { display: flex; gap: 20px; align-items: center; height: 42px; }
        .radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }

        .btn-calc { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3); }
        .btn-calc:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .result-box { margin-top: 30px; display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å…«å­—è¡¨æ ¼ */
        .chart-table { width: 100%; border-collapse: separate; border-spacing: 4px; margin-bottom: 25px; text-align: center; table-layout: fixed; }
        .chart-table th { background: #ecf0f1; padding: 8px 2px; border-radius: 5px; color: #7f8c8d; font-size: 13px; }
        .chart-table td { background: #fff; border: 2px solid #ecf0f1; border-radius: 8px; padding: 10px 2px; vertical-align: top; }
        
        .gan-zhi { font-size: 24px; font-weight: bold; display: block; margin: 5px 0; }
        .god-label-top { font-size: 12px; color: #555; display: block; background: #fafafa; padding: 4px 0; border-radius: 4px; margin-bottom: 5px; font-weight: bold; min-height: 20px; }
        .hidden-stems-box { font-size: 12px; text-align: center; margin-top: 5px; color: #666; min-height: 20px; }
        .main-qi { color: #333; font-weight: bold; display: block; margin-bottom: 2px; font-size: 13px; }
        .sub-qi { color: #999; display: block; font-size: 11px; transform: scale(0.9); }
        .day-master-bg { border-color: #f1c40f !important; background-color: #fffcf0 !important; }
        .wood { color: #27ae60; } .fire { color: #c0392b; } .earth { color: #d35400; } .metal { color: #f39c12; } .water { color: #2980b9; }

        /* ç¶²æ ¼æ’ç‰ˆ */
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .grid-row { grid-template-columns: 1fr; } }

        .analysis-card { background: #f8f9fa; padding: 20px; border-left: 5px solid #764ba2; border-radius: 5px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column;}
        .analysis-card h4 { margin-top: 0; color: #764ba2; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .card-content { font-size: 15px; color: #444; flex-grow: 1; }
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }

        .tag { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; color: white; margin-right: 5px; margin-bottom: 5px;}
        .tag-good { background: #2ecc71; } .tag-bad { background: #e74c3c; }

        /* V2.2 æ”¹é€²çš„å³æ™‚é‹å‹¢å€å¡Š */
        .luck-box { background: linear-gradient(to right, #2c3e50, #4ca1af); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .luck-header { font-size: 18px; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .luck-time { font-size: 12px; opacity: 0.8; }
        .luck-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; margin-top: 10px; }
        .luck-item { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; }
        .luck-label { font-size: 12px; display: block; margin-bottom: 2px; opacity: 0.8; }
        .luck-val { font-size: 18px; font-weight: bold; }
        
        /* é‹å‹¢æƒæåˆ—è¡¨ */
        .luck-scan-list { margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; font-size: 14px; text-align: left; }
        .luck-scan-list ul { margin: 0; padding-left: 20px; }
        .luck-scan-list li { margin-bottom: 8px; }
        .luck-tag-clash { background: #ff6b6b; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 5px; }
        .luck-tag-combine { background: #2ecc71; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 5px; }
        .luck-tag-warn { background: #f1c40f; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 5px; }

        .marketing-box { background: #fff8e1; border: 1px solid #ffe0b2; padding: 20px; border-radius: 10px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; }
        .marketing-title { font-weight: bold; color: #d35400; font-size: 18px; margin-bottom: 10px; text-align: center; }
        .marketing-text { font-size: 13px; color: #555; margin-bottom: 15px; text-align: justify; line-height: 1.5; flex-grow: 1; }
        
        .social-buttons { display: flex; gap: 10px; justify-content: center; margin-top: auto; }
        .btn-social { flex: 1; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s; color: white; font-size: 14px; }
        .btn-line { background-color: #06c755; } .btn-line:hover { background-color: #05b34c; }
        .btn-ig { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); } .btn-ig:hover { opacity: 0.9; }

        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <h1> å…«å­—å‘½ç†  åŸºæœ¬è§£æ</h1>
    <div class="subtitle">è§£ææ ¼å±€ã€èº«å¼·å¼±ã€å¥åº·èˆ‡å³æ™‚æµé‹</div>
    
    <div class="form-row">
        <div class="input-group">
            <label>å‡ºç”Ÿæ—¥æœŸ (åœ‹æ›†)</label>
            <input type="date" id="birthDate">
        </div>
        <div class="input-group">
            <label>å‡ºç”Ÿæ™‚é–“</label>
            <input type="time" id="birthTime" value="12:00">
            <label class="checkbox-wrapper">
                <input type="checkbox" id="unknownTime" onchange="toggleTimeInput()"> 
                ä¸çŸ¥é“å‡ºç”Ÿæ™‚é–“
            </label>
        </div>
    </div>
    <div class="form-row">
        <div class="input-group">
            <label>æ€§åˆ¥</label>
            <div class="gender-group">
                <label class="radio-label"><input type="radio" name="gender" value="1" checked> ç”·</label>
                <label class="radio-label"><input type="radio" name="gender" value="0"> å¥³</label>
            </div>
        </div>
    </div>

    <button class="btn-calc" onclick="calculateBazi()">é–‹å§‹è§£æ</button>

    <div id="result" class="result-box">
        
        <div class="luck-box">
            <div class="luck-header">
                <span><i class="fas fa-clock"></i> å³æ™‚æµé‹è§£æ </span>
                <span class="luck-time" id="currentTimeStr">--:--</span>
            </div>
            <div class="luck-grid">
                <div class="luck-item">
                    <span class="luck-label">æµå¹´</span>
                    <span class="luck-val" id="curYear"></span>
                </div>
                <div class="luck-item">
                    <span class="luck-label">æµæœˆ</span>
                    <span class="luck-val" id="curMonth"></span>
                </div>
                <div class="luck-item">
                    <span class="luck-label">æµæ—¥</span>
                    <span class="luck-val" id="curDay"></span>
                </div>
                <div class="luck-item">
                    <span class="luck-label">æµæ™‚</span>
                    <span class="luck-val" id="curHour"></span>
                </div>
            </div>
            <div class="luck-scan-list" id="currentLuckAdvice">
                æ­£åœ¨æƒææµå¹´æµæœˆèˆ‡æœ¬å‘½å››æŸ±çš„äº¤äº’ä½œç”¨...
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">
        
        <h2 style="text-align:center;"> æœ¬å‘½å…«å­— </h2>
        <table class="chart-table">
            <thead>
                <tr>
                    <th>å¹´æŸ± (ç¥–ä¸Š)</th>
                    <th>æœˆæŸ± (çˆ¶æ¯/äº‹æ¥­)</th>
                    <th>æ—¥æŸ± (æœ¬å‘½/é…å¶)</th>
                    <th>æ™‚æŸ± (å­å¥³/æ™šå¹´)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span id="yearGod" class="god-label-top"></span></td>
                    <td><span id="monthGod" class="god-label-top"></span></td>
                    <td><span class="god-label-top" style="background:#f1c40f; color:white;">å…ƒç¥</span></td>
                    <td><span id="hourGod" class="god-label-top"></span></td>
                </tr>
                <tr>
                    <td id="yearGan"></td>
                    <td id="monthGan"></td>
                    <td id="dayGan" class="day-master-bg"></td>
                    <td id="hourGan"></td>
                </tr>
                <tr>
                    <td id="yearZhi"></td>
                    <td id="monthZhi"></td>
                    <td id="dayZhi" class="day-master-bg"></td>
                    <td id="hourZhi"></td>
                </tr>
                <tr>
                    <td id="yearHidden"></td>
                    <td id="monthHidden"></td>
                    <td id="dayHidden"></td>
                    <td id="hourHidden"></td>
                </tr>
            </tbody>
        </table>

        <div class="analysis-card" style="margin-bottom: 20px;">
            <h4>ğŸ‘¤ æœ¬å‘½æ€§æ ¼è§£æ</h4>
            <p style="margin-bottom:5px;"><strong>æ ¸å¿ƒæœ¬è³ªï¼š</strong> <span id="dayMasterDesc"></span></p>
            <p id="personalityText" class="card-content" style="line-height:1.8;"></p>
        </div>

        <div class="grid-row">
            <div class="analysis-card">
                <h4>âš–ï¸ æ ¼å±€èˆ‡é‹å‹¢å»ºè­°</h4>
                <div class="card-content">
                    <p><strong>æ—¥ä¸»å¼·å¼±ï¼š</strong> <span id="bodyStrength" style="font-weight:bold; color:#d35400;"></span></p>
                    <p><strong>æ ¼å±€åˆ¤æ–·ï¼š</strong> <span id="patternType"></span></p>
                    <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
                    <p style="margin-bottom:5px;"><strong>ğŸ’¡ æ”¹é‹å»ºè­° (å–œç”¨ç¥)ï¼š</strong></p>
                    <div id="luckyAdvice" style="font-size:14px; color:#555;"></div>
                </div>
            </div>

            <div class="analysis-card" style="border-left-color: #3498db;">
                <h4>ğŸ“Š äº”è¡Œèƒ½é‡å¹³è¡¡åœ–</h4>
                <div class="chart-container">
                    <canvas id="wuxingChart"></canvas>
                </div>
                <p id="wuxingComment" style="font-size: 14px; text-align: center; color: #666; margin-top:10px;"></p>
            </div>
        </div>

        <div class="grid-row">
            <div class="analysis-card" style="border-left-color: #e74c3c;">
                <h4>ğŸ¥ äº”è¡Œå¥åº·åˆ†æ</h4>
                <div class="card-content">
                    <p style="font-size:13px; color:#999; margin-bottom:10px;"> åƒ…ä¾›å‘½ç†åƒè€ƒï¼Œèº«é«”ä¸é©è«‹å‹™å¿…å°±é†« </p>
                    <div id="healthRisks"></div>
                </div>
            </div>

            <div class="marketing-box">
                <div class="marketing-title"> âš ï¸ å‘½ç†åƒ…ä¾›åƒè€ƒï¼Œé€ å‘½åœ¨äºº </div>
                <div class="marketing-text">
                    <p>é›»è…¦æ’ç›¤åƒ…èƒ½åˆ†æå…ˆå¤©çµæ§‹ï¼Œä½†äººç”Ÿçš„éš›é‡å¾€å¾€å–æ±ºæ–¼<strong>ã€Œå¤§é‹ã€èˆ‡ã€Œæµå¹´ã€</strong>çš„é…åˆã€‚</p>
                    <ul style="padding-left: 20px; margin: 5px 0;">
                        
                    </ul>
                    <p>æƒ³çŸ¥é“æ›´è©³ç´°çš„è§£æï¼Œæ­¡è¿è¯ç¹«æˆ‘é€²è¡Œå®Œæ•´çš„ä¸€å°ä¸€è«®è©¢ï¼ŒåŠ©æ‚¨è¶¨å‰é¿å‡¶ï¼Œç‚ºæ‚¨æ¶ˆç½ç¥ˆç¦ã€‚</p>
                </div>
                
                <div class="social-buttons">
                    <a href="https://lin.ee/G7u1wKz" target="_blank" class="btn-social btn-line">
                        <i class="fab fa-line"></i> åŠ  LINE è«®è©¢æœå‹™
                    </a>
                    <a href="https://instagram.com/bychenhe" target="_blank" class="btn-social btn-ig">
                        <i class="fab fa-instagram"></i> è¿½è¹¤ IG å¯çœ‹å¤§çœ¾å åœ
                    </a>
                </div>
            </div>
        </div>

    </div>
    
    <div class="footer">
        &copy; 2024 å…«å­—å‘½ç†ç³»çµ± | V2.4 å½ˆæ€§æ™‚è¾°ç‰ˆ
    </div>
</div>

<script>
    function toggleTimeInput() {
        const isUnknown = document.getElementById('unknownTime').checked;
        const timeInput = document.getElementById('birthTime');
        if(isUnknown) {
            timeInput.disabled = true;
            timeInput.style.backgroundColor = '#f0f0f0';
            timeInput.style.color = '#aaa';
        } else {
            timeInput.disabled = false;
            timeInput.style.backgroundColor = '#fff';
            timeInput.style.color = '#000';
        }
    }

    // === å·¥å…·å‡½æ•¸ ===
    function toTraditional(str) {
        if (!str) return '';
        return str.toString()
            .replace(/è´¢/g, 'è²¡').replace(/ä¼¤/g, 'å‚·').replace(/æ€/g, 'æ®º')
            .replace(/æ­/g, 'æ¢Ÿ').replace(/ä¸‘/g, 'ä¸‘').replace(/è¿/g, 'é‹')
            .replace(/å†²/g, 'æ²–').replace(/å…‹/g, 'å‰‹').replace(/åˆ/g, 'åˆ');
    }

    const getElementClass = (char) => {
        const mapping = {
            'ç”²': 'wood', 'ä¹™': 'wood', 'å¯…': 'wood', 'å¯': 'wood',
            'ä¸™': 'fire', 'ä¸': 'fire', 'å·³': 'fire', 'åˆ': 'fire',
            'æˆŠ': 'earth', 'å·±': 'earth', 'è¾°': 'earth', 'æˆŒ': 'earth', 'ä¸‘': 'earth', 'æœª': 'earth',
            'åºš': 'metal', 'è¾›': 'metal', 'ç”³': 'metal', 'é…‰': 'metal',
            'å£¬': 'water', 'ç™¸': 'water', 'äº¥': 'water', 'å­': 'water'
        };
        return mapping[char] || '';
    };

    const getElementFromChar = (char) => {
        const map = {'wood':'æœ¨', 'fire':'ç«', 'earth':'åœŸ', 'metal':'é‡‘', 'water':'æ°´'};
        return map[getElementClass(char)];
    };

    const renderChar = (char) => {
        const tradChar = toTraditional(char);
        return `<span class="gan-zhi ${getElementClass(tradChar)}">${tradChar}</span>`;
    };

    const renderHiddenStems = (stemsArray) => {
        if (!stemsArray || stemsArray.length === 0) return '';
        let html = '<div class="hidden-stems-box">';
        html += `<span class="main-qi">${toTraditional(stemsArray[0])}</span>`;
        if (stemsArray.length > 1) {
            for (let i = 1; i < stemsArray.length; i++) {
                html += `<span class="sub-qi">${toTraditional(stemsArray[i])}</span>`;
            }
        }
        html += '</div>';
        return html;
    };

    let radarChart = null;

    // === ä¸»ç¨‹å¼ ===
    function calculateBazi() {
        const dateInput = document.getElementById('birthDate').value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const isUnknownTime = document.getElementById('unknownTime').checked;

        if (!dateInput) {
            alert('è«‹è¼¸å…¥å‡ºç”Ÿæ—¥æœŸ');
            return;
        }

        let hour, minute;
        
        if (isUnknownTime) {
            // å¦‚æœä¸çŸ¥é“æ™‚é–“ï¼Œæˆ‘å€‘ä½¿ç”¨ 12:00 ä½œç‚ºåŸºæº–ä¾†å–æ—¥æŸ± (é¿å…å­æ™‚äº¤ç•Œå•é¡Œ)
            // è¦–è¦ºä¸Šæœƒé¡¯ç¤º"å‰æ™‚"ï¼Œè¨ˆç®—ä¸Šæœƒå¿½ç•¥æ™‚æŸ±
            hour = 12;
            minute = 0;
        } else {
            const timeInput = document.getElementById('birthTime').value;
            if(!timeInput) {
                 alert('è«‹è¼¸å…¥å‡ºç”Ÿæ™‚é–“ï¼Œæˆ–å‹¾é¸ã€Œä¸çŸ¥é“å‡ºç”Ÿæ™‚é–“ã€');
                 return;
            }
            [hour, minute] = timeInput.split(':').map(Number);
        }

        const [year, month, day] = dateInput.split('-').map(Number);
        const solar = Solar.fromYmdHms(year, month, day, hour, minute, 0);
        const lunar = solar.getLunar();
        const baZi = lunar.getEightChar();
        
        document.getElementById('result').style.display = 'block';

        // æ¸²æŸ“å…«å­—
        document.getElementById('yearGan').innerHTML = renderChar(baZi.getYearGan());
        document.getElementById('yearZhi').innerHTML = renderChar(baZi.getYearZhi());
        document.getElementById('monthGan').innerHTML = renderChar(baZi.getMonthGan());
        document.getElementById('monthZhi').innerHTML = renderChar(baZi.getMonthZhi());
        document.getElementById('dayGan').innerHTML = renderChar(baZi.getDayGan());
        document.getElementById('dayZhi').innerHTML = renderChar(baZi.getDayZhi());

        document.getElementById('yearGod').innerText = toTraditional(baZi.getYearShiShenGan());
        document.getElementById('monthGod').innerText = toTraditional(baZi.getMonthShiShenGan());
        
        document.getElementById('yearHidden').innerHTML = renderHiddenStems(baZi.getYearShiShenZhi());
        document.getElementById('monthHidden').innerHTML = renderHiddenStems(baZi.getMonthShiShenZhi());
        document.getElementById('dayHidden').innerHTML = renderHiddenStems(baZi.getDayShiShenZhi());

        // è™•ç†æ™‚æŸ±é¡¯ç¤º
        if (isUnknownTime) {
            document.getElementById('hourGan').innerHTML = '<span class="gan-zhi" style="color:#aaa;">å‰</span>';
            document.getElementById('hourZhi').innerHTML = '<span class="gan-zhi" style="color:#aaa;">æ™‚</span>';
            document.getElementById('hourGod').innerText = '';
            document.getElementById('hourHidden').innerHTML = '';
        } else {
            document.getElementById('hourGan').innerHTML = renderChar(baZi.getTimeGan());
            document.getElementById('hourZhi').innerHTML = renderChar(baZi.getTimeZhi());
            document.getElementById('hourGod').innerText = toTraditional(baZi.getTimeShiShenGan());
            document.getElementById('hourHidden').innerHTML = renderHiddenStems(baZi.getTimeShiShenZhi());
        }

        // è§£æåŠŸèƒ½
        analyzeBasic(baZi);
        const scores = calculateFiveElementsScore(baZi, isUnknownTime);
        renderRadarChart(scores);
        analyzeStrengthAndAdvice(baZi, scores, isUnknownTime);
        analyzeHealth(scores);
        
        // V2.2 å‡ç´šç‰ˆå³æ™‚é‹å‹¢ (å«è»Šé—œæƒæ)
        analyzeDetailedCurrentLuck(baZi, isUnknownTime);

        setTimeout(() => {
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }

    // === åˆ†ææ¨¡çµ„ ===
    function analyzeBasic(baZi) {
        const dayGan = baZi.getDayGan();
        const personalities = {
            'ç”²': 'ç”²æœ¨å¦‚åƒå¤©å¤§æ¨¹ï¼Œæ­£ç›´ä»æ…ˆï¼Œä¸å±ˆä¸æ’“ã€‚æ‚¨æœ‰é ˜è¢–æ°£è³ªï¼Œä½†æœ‰æ™‚éæ–¼å›ºåŸ·ï¼Œä¸é¡˜è®Šé€šã€‚è‹¥èƒ½å­¸æœƒå½è…°ï¼Œæˆå°±å°‡ä¸å¯é™é‡ã€‚',
            'ä¹™': 'ä¹™æœ¨å¦‚èŠ±è‰è—¤è”“ï¼Œèº«æ®µæŸ”è»Ÿï¼Œé©æ‡‰åŠ›å¼·ã€‚æ‚¨å–„æ–¼äº¤éš›ï¼Œå¿ƒæ€ç´°è†©ï¼Œä½†å®¹æ˜“ä¾è³´ä»–äººã€‚åœ¨è¤‡é›œçš„ç’°å¢ƒä¸­å¾€å¾€èƒ½ç”Ÿå­˜åˆ°æœ€å¾Œã€‚',
            'ä¸™': 'ä¸™ç«å¦‚å¤ªé™½ï¼Œç†±æƒ…é–‹æœ—ï¼Œä¸æ‹˜å°ç¯€ã€‚æ‚¨æ¨‚æ–¼åŠ©äººï¼Œæƒ…ç·’ä¾†å»å¾—å¿«ï¼Œä½†æœ‰æ™‚å®¹æ˜“è¡å‹•ã€‚æ‚¨çš„å‡ºç¾ç¸½èƒ½é©…æ•£é™°éœ¾ï¼Œæ˜¯åœ˜éšŠçš„å°å¤ªé™½ã€‚',
            'ä¸': 'ä¸ç«å¦‚ç‡­å…‰ï¼Œæº«æš–è²¼å¿ƒï¼Œæ´å¯ŸåŠ›å¼·ã€‚æ‚¨å¤–è¡¨æ²ˆç©©å…§å¿ƒç†±æƒ…ï¼Œæœ‰çŠ§ç‰²å¥‰ç»çš„ç²¾ç¥ã€‚å¾€å¾€æ˜¯åœ˜éšŠä¸­é»˜é»˜ä»˜å‡ºçš„æ™ºå›Šè§’è‰²ã€‚',
            'æˆŠ': 'æˆŠåœŸå¦‚é«˜å±±ï¼Œç©©é‡åšå¯¦ï¼Œè¬›æ±‚ä¿¡ç”¨ã€‚æ‚¨åŒ…å®¹åŠ›å¼·ï¼Œå–œæ­¡ç©©å®šï¼Œä½†åæ‡‰æœ‰æ™‚è¼ƒæ…¢ã€‚æ‚¨çµ¦äººå¼·å¤§çš„å®‰å…¨æ„Ÿï¼Œå€¼å¾—ä¿¡è³´ã€‚',
            'å·±': 'å·±åœŸå¦‚ç”°åœ’ï¼Œå…§æ–‚è¬¹æ…ï¼Œå¤šæ‰å¤šè—ã€‚æ‚¨åšäº‹ç´°å¿ƒï¼Œä½†å®¹æ˜“å„ªæŸ”å¯¡æ–·ï¼Œæƒ³å¾—å¤ªå¤šã€‚æ‚¨å–„æ–¼å­•è‚²èˆ‡åŸ¹é¤Šï¼Œé©åˆæ•™è‚²æˆ–è¼”ä½ä»–äººã€‚',
            'åºš': 'åºšé‡‘å¦‚åˆ€åŠï¼Œå‰›æ¯…æœæ–·ï¼Œè¬›ç¾©æ°£ã€‚æ‚¨åŸ·è¡ŒåŠ›å¼·ï¼Œæ„›æ†åˆ†æ˜ï¼Œä½†æœ‰æ™‚éæ–¼å¼·å‹¢å‚·äººã€‚ç¶“éç£¨ç·´çš„åºšé‡‘èƒ½æˆå¤§å™¨ã€‚',
            'è¾›': 'è¾›é‡‘å¦‚ç å¯¶ï¼Œç²¾ç·»å„ªé›…ï¼Œé‡è¦–è³ªæ„Ÿã€‚æ‚¨å£æ‰ä½³ï¼Œæ„Ÿå—åŠ›æ•éŠ³ï¼Œä½†è‡ªå°Šå¿ƒå¼·ï¼Œå—ä¸äº†æ‰¹è©•ã€‚æ‚¨å¸Œæœ›è¢«å‘µè­·å’Œæ¬£è³ã€‚',
            'å£¬': 'å£¬æ°´å¦‚æ±Ÿæ²³ï¼Œå¥”æ”¾è‡ªç”±ï¼Œè°æ˜æ©Ÿæ™ºã€‚æ‚¨åæ‡‰å¿«ï¼Œäººè„ˆå»£ï¼Œä½†æœ‰æ™‚æµå‹•æ€§å¤ªå¼·ç¼ºä¹å®šæ€§ã€‚æ“æœ‰å¤§æ™ºæ…§ï¼Œé©åˆè®Šå‹•æ€§é«˜çš„å·¥ä½œã€‚',
            'ç™¸': 'ç™¸æ°´å¦‚é›¨éœ²ï¼Œæº«æŸ”å…§å‘ï¼Œæƒ³åƒåŠ›å¯Œã€‚æ‚¨å¿ƒæ€ç´°å¯†ï¼Œå–„æ–¼è§€å¯Ÿï¼Œä½†æƒ…ç·’å®¹æ˜“å—ç’°å¢ƒå½±éŸ¿ã€‚æ‚¨å¤–è¡¨å¹³éœï¼Œå…§å¿ƒå»æƒ…æ„Ÿè±å¯Œã€‚'
        };
        
        document.getElementById('dayMasterDesc').innerText = `${toTraditional(dayGan)}æ—¥ä¸» (${getElementFromChar(dayGan)})`;
        document.getElementById('personalityText').innerText = personalities[dayGan] || '';

        const patternGod = toTraditional(baZi.getMonthShiShenZhi()[0]);
        document.getElementById('patternType').innerText = patternGod + "æ ¼ (æœˆä»¤ä¸»æ°£)";
    }

    function calculateFiveElementsScore(baZi, isUnknownTime) {
        let scores = { 'é‡‘': 0, 'æœ¨': 0, 'æ°´': 0, 'ç«': 0, 'åœŸ': 0 };
        const addScore = (char, weight) => {
            const el = getElementFromChar(char);
            if(el) scores[el] += (10 * weight);
        };
        addScore(baZi.getYearGan(), 1.0);
        addScore(baZi.getMonthGan(), 1.0);
        addScore(baZi.getDayGan(), 1.0);
        addScore(baZi.getYearZhi(), 1.0);
        addScore(baZi.getMonthZhi(), 2.5); // æœˆä»¤æ¬Šé‡æœ€é‡
        addScore(baZi.getDayZhi(), 1.5);

        // å¦‚æœçŸ¥é“æ™‚é–“ï¼Œæ‰åŠ å…¥æ™‚æŸ±åˆ†æ•¸
        if (!isUnknownTime) {
            addScore(baZi.getTimeGan(), 1.0);
            addScore(baZi.getTimeZhi(), 1.0);
        }

        return scores;
    }

    function renderRadarChart(scores) {
        const ctx = document.getElementById('wuxingChart').getContext('2d');
        const dataValues = [scores['æœ¨'], scores['ç«'], scores['åœŸ'], scores['é‡‘'], scores['æ°´']];
        let maxVal = 0; let maxEl = '';
        let minVal = 999; let minEl = '';
        const els = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
        dataValues.forEach((v, i) => {
            if(v > maxVal) { maxVal = v; maxEl = els[i]; }
            if(v < minVal) { minVal = v; minEl = els[i]; }
        });
        document.getElementById('wuxingComment').innerHTML = 
            `<strong>${maxEl}</strong> æ°£æœ€æ—ºï¼Œ<strong>${minEl}</strong> æ°£è¼ƒå¼±ã€‚`;

        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'],
                datasets: [{
                    label: 'äº”è¡Œèƒ½é‡',
                    data: dataValues,
                    backgroundColor: 'rgba(118, 75, 162, 0.2)',
                    borderColor: '#764ba2',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#764ba2'
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: { r: { beginAtZero: true, suggestMax: 30 } }, // Maxå€¼ç¨å¾®èª¿ä½ä¸€é»å› ç‚ºå°‘äº†æ™‚æŸ±
                plugins: { legend: { display: false } }
            }
        });
    }

    function analyzeStrengthAndAdvice(baZi, scores, isUnknownTime) {
        const me = getElementFromChar(baZi.getDayGan());
        const supportMap = {
            'æœ¨': ['æœ¨', 'æ°´'], 'ç«': ['ç«', 'æœ¨'], 'åœŸ': ['åœŸ', 'ç«'], 
            'é‡‘': ['é‡‘', 'åœŸ'], 'æ°´': ['æ°´', 'é‡‘']
        };
        const sameParty = supportMap[me];
        let sameScore = 0; let otherScore = 0;
        for (let el in scores) {
            if (sameParty.includes(el)) sameScore += scores[el];
            else otherScore += scores[el];
        }
        const isStrong = sameScore > otherScore;
        
        let strengthText = isStrong ? 'èº«å¼· (èƒ½é‡å……æ²›)' : 'èº«å¼± (éœ€è¦å¹«æ‰¶)';
        if (isUnknownTime) {
            strengthText += ' <span style="font-size:12px; color:#999; display:block; margin-top:2px;">(âš ï¸ ç¼ºå°‘æ™‚æŸ±è³‡æ–™ï¼Œæº–ç¢ºåº¦ç´„70%)</span>';
        }
        document.getElementById('bodyStrength').innerHTML = strengthText;

        let adviceHtml = '';
        if (isStrong) {
            adviceHtml += `<span class="tag tag-bad">å¿Œï¼š${sameParty.join('ã€')}</span> (å¤šå‰‡ç‚ºæ‚£)<br>`;
            adviceHtml += `æ‚¨èƒ½é‡å¼·ï¼Œå€‹æ€§ä¸»è§€ã€‚<strong>å–œç”¨ç¥ç‚ºã€Œå‰‹æ´©ã€</strong>ï¼ˆç•°é»¨ï¼‰ã€‚<br>`;
            adviceHtml += `å»ºè­°å¤šç©¿é${me}ç³»é¡è‰²è¡£ç‰©ï¼Œé€éè¼¸å‡ºæ‰è¯(é£Ÿå‚·)æˆ–è¿½æ±‚äº‹æ¥­(å®˜æ®º)æ¶ˆè€—éå‰©ç²¾åŠ›ã€‚`;
        } else {
            adviceHtml += `<span class="tag tag-good">å–œï¼š${sameParty.join('ã€')}</span> (è²´äººé‹)<br>`;
            adviceHtml += `æ‚¨èƒ½é‡è¼ƒå¼±ï¼Œæ˜“å—ç’°å¢ƒå½±éŸ¿ã€‚<strong>å–œç”¨ç¥ç‚ºã€Œç”Ÿæ‰¶ã€</strong>ï¼ˆåŒé»¨ï¼‰ã€‚<br>`;
            adviceHtml += `å»ºè­°å¤šç©¿${sameParty[0]}æˆ–${sameParty[1]}è‰²ç³»ï¼Œé…æˆ´é£¾å“ï¼Œå¤šèˆ‡è²´äººè¦ªè¿‘å¢åŠ åº•æ°£ã€‚`;
        }
        document.getElementById('luckyAdvice').innerHTML = adviceHtml;
    }

    function analyzeHealth(scores) {
        let risks = [];
        const thresholdHigh = 35;
        const thresholdLow = 8;
        const healthMap = {
            'æœ¨': 'è‚è†½ã€ç¥ç¶“ã€ç­‹éª¨',
            'ç«': 'å¿ƒè¡€ç®¡ã€å°è…¸ã€çœ¼',
            'åœŸ': 'è„¾èƒƒã€æ¶ˆåŒ–ã€çš®è†š',
            'é‡‘': 'è‚ºéƒ¨ã€å‘¼å¸ã€å¤§è…¸',
            'æ°´': 'è…è‡Ÿã€æ³Œå°¿ã€è¡€æ¶²'
        };
        for (let el in scores) {
            if (scores[el] > thresholdHigh) risks.push(`<i class="fas fa-exclamation-triangle" style="color:#e74c3c;"></i> <strong>${el}éæ—ºï¼š</strong>${healthMap[el]}`);
            if (scores[el] < thresholdLow) risks.push(`<i class="fas fa-arrow-down" style="color:#f39c12;"></i> <strong>${el}å¤ªå¼±ï¼š</strong>${healthMap[el]}`);
        }
        if (risks.length === 0) {
            document.getElementById('healthRisks').innerHTML = '<span style="color:#2ecc71;"><i class="fas fa-check-circle"></i> äº”è¡Œæµé€šå¹³è¡¡ï¼Œè«‹ä¿æŒè‰¯å¥½ä½œæ¯ã€‚</span>';
        } else {
            document.getElementById('healthRisks').innerHTML = risks.join('<br><br>');
        }
    }

    // === V2.2 æ ¸å¿ƒï¼šå…¨ç›¤æƒæ (å«è»Šé—œæª¢æ¸¬) ===
    function analyzeDetailedCurrentLuck(baZi, isUnknownTime) {
        const now = new Date();
        const curSolar = Solar.fromDate(now);
        const curLunar = curSolar.getLunar();
        const curBaZi = curLunar.getEightChar();

        document.getElementById('currentTimeStr').innerText = `${now.getHours()}:${now.getMinutes() < 10 ? '0'+now.getMinutes() : now.getMinutes()}`;
        document.getElementById('curYear').innerHTML = toTraditional(curBaZi.getYearGan()) + toTraditional(curBaZi.getYearZhi());
        document.getElementById('curMonth').innerHTML = toTraditional(curBaZi.getMonthGan()) + toTraditional(curBaZi.getMonthZhi());
        document.getElementById('curDay').innerHTML = toTraditional(curBaZi.getDayGan()) + toTraditional(curBaZi.getDayZhi());
        document.getElementById('curHour').innerHTML = toTraditional(curBaZi.getTimeGan()) + toTraditional(curBaZi.getTimeZhi());

        const currentPillars = [
            { name: "æµå¹´", gan: curBaZi.getYearGan(), zhi: curBaZi.getYearZhi() },
            { name: "æµæœˆ", gan: curBaZi.getMonthGan(), zhi: curBaZi.getMonthZhi() },
            { name: "æµæ—¥", gan: curBaZi.getDayGan(), zhi: curBaZi.getDayZhi() },
            { name: "æµæ™‚", gan: curBaZi.getTimeGan(), zhi: curBaZi.getTimeZhi() }
        ];

        let userPillars = [
            { name: "å¹´æŸ±(ç¥–ä¸Š)", gan: baZi.getYearGan(), zhi: baZi.getYearZhi() },
            { name: "æœˆæŸ±(äº‹æ¥­)", gan: baZi.getMonthGan(), zhi: baZi.getMonthZhi() },
            { name: "æ—¥æŸ±(è‡ªå·±)", gan: baZi.getDayGan(), zhi: baZi.getDayZhi() }
        ];

        // åªæœ‰åœ¨çŸ¥é“æ™‚é–“çš„æƒ…æ³ä¸‹ï¼Œæ‰æŠŠæ™‚æŸ±åŠ å…¥æƒæå°è±¡
        if (!isUnknownTime) {
            userPillars.push({ name: "æ™‚æŸ±(å­å¥³)", gan: baZi.getTimeGan(), zhi: baZi.getTimeZhi() });
        }

        const chongMap = {'å­':'åˆ', 'åˆ':'å­', 'ä¸‘':'æœª', 'æœª':'ä¸‘', 'å¯…':'ç”³', 'ç”³':'å¯…', 'å¯':'é…‰', 'é…‰':'å¯', 'è¾°':'æˆŒ', 'æˆŒ':'è¾°', 'å·³':'äº¥', 'äº¥':'å·³'};
        const heMap = {'å­':'ä¸‘', 'ä¸‘':'å­', 'å¯…':'äº¥', 'äº¥':'å¯…', 'å¯':'æˆŒ', 'æˆŒ':'å¯', 'è¾°':'é…‰', 'é…‰':'è¾°', 'å·³':'ç”³', 'ç”³':'å·³', 'åˆ':'æœª', 'æœª':'åˆ'};

        let findings = [];
        
        currentPillars.forEach(curr => {
            userPillars.forEach(user => {
                // B. åœ°æ”¯å…­æ²–
                if (chongMap[user.zhi] === curr.zhi) {
                    let impact = "è®Šå‹•ã€è¡çªã€é è¡Œ";
                    if(user.name.includes("æ—¥æŸ±")) impact = "æƒ…ç·’ä¸ç©©ã€å¤«å¦»å£è§’ã€æ„å¤–";
                    if(user.name.includes("æœˆæŸ±")) impact = "å·¥ä½œè®Šå‹•ã€çˆ¶æ¯èº«é«”ç•™æ„";
                    if(user.name.includes("å¹´æŸ±")) impact = "é•·è¼©å¥åº·ã€ç¥–ç”¢è®Šå‹•";
                    
                    // === æ–°å¢é‚è¼¯ï¼šå¯…ç”³æ²–ã€å·³äº¥æ²– (è»Šé—œæé†’) ===
                    const travelStars = ['å¯…', 'ç”³', 'å·³', 'äº¥'];
                    if (travelStars.includes(user.zhi) && travelStars.includes(curr.zhi)) {
                        impact += "ã€<span style='color:red; font-weight:bold;'>âš ï¸å°å¿ƒè»Šé—œ</span>";
                    }
                    
                    findings.push(`<li><span class="luck-tag-clash">æ²–</span> <strong>${curr.name}</strong> æ²– <strong>${user.name}</strong>ï¼š<br><small>(${curr.zhi}æ²–${user.zhi}) ç•™æ„${impact}ã€‚</small></li>`);
                }

                // C. åœ°æ”¯å…­åˆ
                if (heMap[user.zhi] === curr.zhi) {
                    let impact = "è²´äººäº’åŠ©ã€åˆä½œé †åˆ©";
                    if(user.name.includes("æ—¥æŸ±")) impact = "æ„Ÿæƒ…ç”œèœœã€äººç·£ä½³";
                    
                    findings.push(`<li><span class="luck-tag-combine">åˆ</span> <strong>${curr.name}</strong> åˆ <strong>${user.name}</strong>ï¼š<br><small>(${curr.zhi}åˆ${user.zhi}) ${impact}ã€‚</small></li>`);
                }

                // D. ä¼åŸ
                if (curr.gan === user.gan && curr.zhi === user.zhi) {
                    findings.push(`<li><span class="luck-tag-warn">ä¼åŸ</span> <strong>${curr.name}</strong> é‡ç–Š <strong>${user.name}</strong>ï¼š<br><small>èƒ½é‡å¢å¼·æˆ–åœæ»¯ï¼Œå®œéœä¸å®œå‹•ï¼Œæ³¨æ„å“­æ³£å‘»åŸä¹‹äº‹ã€‚</small></li>`);
                }
            });
        });

        const listDiv = document.getElementById('currentLuckAdvice');
        if (findings.length > 0) {
            listDiv.innerHTML = `<ul>${findings.join('')}</ul>`;
        } else {
            listDiv.innerHTML = `
                <div style="text-align:center; padding:10px;">
                    <span style="color:#2ecc71; font-size:16px;">
                        <i class="fas fa-coffee"></i> ç„¡æ˜é¡¯æ²–åˆï¼Œæ ¼å±€å¹³ç©©ã€‚
                    </span>
                    <p style="font-size:12px; color:#aaa; margin-top:5px;">é©åˆæŒ‰éƒ¨å°±ç­åŸ·è¡Œè¨ˆç•«ã€‚</p>
                </div>`;
        }
    }
</script>

</body>
</html>